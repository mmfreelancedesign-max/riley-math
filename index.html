<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riley's Pink Math Playground</title>
<!-- Defensive CSP: keep inline allowed for this single-file app; block remote connections by default -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:; img-src 'self' data: blob:; media-src 'self' data: blob:; connect-src 'self' data: blob:;">

<!-- EARLY SAFETY GUARD: catch MetaMask/Web3 errors ASAP (before anything else runs) -->
<script>
(function(){
  if (window.__web3GuardInstalled) return; // avoid double-install
  window.__web3GuardInstalled = true;
  function matchesMM(msg){ return /metamask|web3|ethereum/i.test(String(msg||'')); }
  // Capture early
  window.addEventListener('error', function(e){
    try{
      const m = e && (e.message || (e.error && e.error.message));
      if(matchesMM(m)){ e.preventDefault(); e.stopImmediatePropagation?.(); }
    }catch(_){}
  }, {capture:true});
  window.addEventListener('unhandledrejection', function(e){
    try{
      const r = e && (e.reason && (e.reason.message||e.reason));
      if(matchesMM(r)){ e.preventDefault(); e.stopImmediatePropagation?.(); }
    }catch(_){}
  }, {capture:true});
  // Soft-disable auto wallet prompts inside sandboxed UIs to avoid crashes
  try{
    if (window.ethereum && !window.__allowEthereum){
      const eth = window.ethereum;
      const origReq = typeof eth.request==='function' ? eth.request.bind(eth) : null;
      eth.request = function(args){
        const method = (args && args.method) ? String(args.method) : '';
        if(/eth_requestAccounts|eth_accounts|wallet_|eth_chainId/i.test(method)){
          // Return a promise that is caught internally to avoid global rejections
          const p = Promise.reject(new Error('Ethereum provider disabled for this app'));
          p.catch(()=>{}); // swallow to avoid unhandledrejection
          return p;
        }
        return origReq ? origReq(args) : Promise.reject(new Error('No provider'));
      };
    }
  }catch(_){ /* ignore */ }
})();
</script>

<style>
  :root{
    --pink:#ff5aa5; /* primary */
    --pink-dark:#e64a95;
    --pink-light:#ffd3ea;
    --accent:#ffd84d; /* stars */
    --bg:#fff4fa;
    --good:#37b24d;
    --bad:#fa5252;
    --text:#3a2a35;
    --card:#ffffff;
    --shadow:0 8px 20px rgba(255,90,165,.25);
    --radius:18px;
  }
  html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
  .app{ max-width:960px; margin:0 auto; padding:12px 12px 80px; position:relative; }
  header{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--pink),var(--pink-dark)); color:#fff; padding:12px; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius); box-shadow:var(--shadow); }
  .brand{ display:flex; align-items:center; gap:10px; }
  .brand .logo{ width:44px; height:44px; background:#fff; border-radius:50%; display:grid; place-items:center; box-shadow:0 4px 10px rgba(0,0,0,.1); }
  .brand .logo span{ font-size:26px; }
  .brand h1{ font-size:22px; margin:0; }
  .top-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .btn{ background:#fff; color:var(--pink-dark); border:none; padding:12px 16px; border-radius:14px; font-weight:700; box-shadow:var(--shadow); cursor:pointer; font-size:16px; min-height:48px; }
  .btn.secondary{ background:var(--pink-light); color:#8b2a64; }
  .btn.ghost{ background:transparent; border:2px solid #fff; color:#fff; }
  .btn:active{ transform:translateY(1px)}
  .pill{ display:inline-flex; align-items:center; gap:6px; background:#fff; color:var(--pink-dark); border-radius:999px; padding:6px 10px; font-weight:700; box-shadow:var(--shadow); }
  .progress-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .star{ color:var(--accent); }

  main{ margin-top:14px; }
  .card{ background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .tile{ display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; background:linear-gradient(180deg,#fff,#ffe7f3); border-radius:20px; padding:18px; min-height:130px; cursor:pointer; border:3px solid var(--pink-light); }
  .tile .emoji{ font-size:38px; }
  .tile h3{ margin:6px 0 0; text-align:center; }

  .hide{ display:none !important; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .center{ text-align:center; }

  /* Question UI */
  .question-area{ display:flex; flex-direction:column; gap:12px; }
  .question-box{ font-size:28px; background:#fff; border:3px dashed var(--pink); border-radius:18px; padding:16px; text-align:center; }
  .choices{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
  .choice{ background:#fff; border:3px solid var(--pink-light); border-radius:14px; padding:12px; font-size:22px; font-weight:800; cursor:pointer; text-align:center; box-shadow:var(--shadow); }
  .choice:active{ transform:translateY(1px) }
  .answer-input{ font-size:26px; text-align:center; padding:10px; border-radius:12px; border:3px solid var(--pink); width:160px; }
  .hint{ background:#fff8fb; border-left:6px solid var(--pink); padding:10px; border-radius:12px; }
  .session-bar{ height:14px; background:var(--pink-light); border-radius:999px; overflow:hidden; }
  .session-bar > div{ height:100%; width:0; background:linear-gradient(90deg,var(--pink),var(--accent)); }

  /* Confetti canvas */
  #confetti{ position:fixed; inset:0; pointer-events:none; z-index:20; }

  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:30; }
  .modal .inner{ background:#fff; width:min(680px,94vw); max-height:90vh; overflow:auto; border-radius:20px; padding:16px; box-shadow:var(--shadow); }
  .modal.show{ display:flex; }

  /* Game */
  .game-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  #gameCanvas{ background:linear-gradient(180deg,#ffe6f4,#fff); border:4px solid var(--pink); border-radius:16px; box-shadow:var(--shadow); touch-action:none; }
  .dpad{ display:grid; grid-template-areas:". up ." "left . right" ". down ."; gap:8px; }
  .dpad button{ width:68px; height:68px; border-radius:18px; border:none; background:#fff; box-shadow:var(--shadow); font-size:22px; }
  .badge{ display:inline-flex; align-items:center; gap:6px; background:var(--pink-dark); color:#fff; padding:6px 10px; border-radius:999px; font-weight:800; }

  /* Parent view */
  .stats{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .bar{ background:var(--pink-light); height:16px; border-radius:12px; overflow:hidden; }
  .bar > div{ height:100%; width:0; background:linear-gradient(90deg,var(--pink),var(--accent)); }
  .note{ background:#fff6ff; border-left:6px solid var(--accent); padding:10px; border-radius:14px; }

  /* Sticker book */
  .sticker-wrap{ display:grid; grid-template-columns: 200px 1fr; gap:12px; }
  .sticker-palette{ background:#fff; border-radius:16px; padding:10px; box-shadow:var(--shadow); }
  .sticker-palette .st{ font-size:36px; cursor:grab; display:inline-block; margin:6px; }
  .sticker-board{ background:#fff; border-radius:16px; min-height:300px; padding:10px; box-shadow:var(--shadow); position:relative; }
  .placed{ position:absolute; font-size:44px; cursor:move; touch-action:none; }

  footer{ position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:4px solid var(--pink-light); padding:8px; }
  .footer-nav{ display:flex; gap:8px; max-width:960px; margin:0 auto; }
  .footer-nav .btn{ flex:1; }

  /* Toast */
  .toast{ position:fixed; right:12px; bottom:76px; background:#fff; color:var(--text); border-left:6px solid var(--pink); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); display:none; z-index:50; }
  .toast.show{ display:block; }

  /* Fill-screen fallback (pseudo fullscreen inside iframes) */
  .fill-active header, .fill-active footer{ display:none !important; }
  .fill-active .app{ max-width:100vw; padding:0; }
  .fill-active main .card{ border-radius:0; }
  .fill-active #gameCanvas{ touch-action:none; }

  @media (max-width:560px){
    .grid{ grid-template-columns:repeat(2,1fr); }
    .stats{ grid-template-columns:1fr; }
    .sticker-wrap{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"><span>💜</span></div>
      <div>
        <h1>Riley's Pink Math Playground</h1>
        <div class="progress-row" id="progressRow">
          <span class="pill" title="Streak"><span>🔥</span><b id="streakDays">0</b> day streak</span>
          <span class="pill" title="Stars"><span class="star">⭐</span><b id="starCount">0</b> stars</span>
          <span class="pill" title="Badges"><span>🏅</span><b id="badgeCount">0</b> badges</span>
          <span class="pill" id="favPill">🎵 Favorite: <b id="favGroup">Huntrix</b></span>
        </div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnToggleSound">🔊 Sounds On</button>
      <button class="btn" id="btnToggleTTS">🗣️ Read Aloud On</button>
      <button class="btn" id="btnVoice">🎙️ Voice</button>
      <button class="btn" id="btnChime">🎵 Huntrix Cheer</button>
      <button class="btn" id="btnFullscreen">⛶ Full Screen</button>
      <button class="btn" id="btnPopout">🪟 Pop Out</button>
      <button class="btn" id="btnDownload">💾 Download HTML</button>
      <button class="btn secondary" id="btnExport">📤 Export Progress</button>
      <button class="btn secondary" id="btnImport">📥 Import Progress</button>
      <input type="file" id="fileImport" accept="application/json" class="hide" />
      <button class="btn secondary" id="btnParent">👪 Parent View</button>
      <button class="btn secondary" id="btnDiag">🔧 Diagnostics</button>
      <button class="btn ghost" id="btnReset">♻️ Reset Progress</button>
    </div>
  </header>

  <main>
    <!-- Home -->
    <section id="home" class="card">
      <h2 class="center">Hi Riley! Choose an activity</h2>
      <div class="grid">
        <div class="tile" data-activity="arithmetic"><div class="emoji">➕➖✖️➗</div><h3>Quick-Fire Arithmetic</h3></div>
        <div class="tile" data-activity="bonds"><div class="emoji">🧩</div><h3>Number Bonds</h3></div>
        <div class="tile" data-activity="place"><div class="emoji">🏗️</div><h3>Place Value</h3></div>
        <div class="tile" data-activity="tables"><div class="emoji">📙</div><h3>Times Tables</h3></div>
        <div class="tile" data-activity="words"><div class="emoji">📖</div><h3>Word Problems</h3></div>
        <div class="tile" id="tileGame"><div class="emoji">🐱🧁</div><h3>Bella & Cupcakes</h3></div>
        <div class="tile" id="tileStickers"><div class="emoji">🏷️</div><h3>My Reward Sticker Book</h3></div>
      </div>
    </section>

    <!-- Activity -->
    <section id="activity" class="card hide">
      <div class="row" style="justify-content:space-between">
        <div class="pill"><span id="activityIcon">🎯</span> <b id="activityTitle">Activity</b></div>
        <div class="pill">Question <b id="qNum">1</b>/10</div>
      </div>
      <div class="session-bar" aria-hidden="true"><div id="sessionProgress"></div></div>
      <div class="question-area">
        <div id="visuals" class="center"></div>
        <div class="question-box" id="questionText">What is 2 + 3?</div>
        <div id="answerUI" class="center"></div>
        <div class="row center" style="justify-content:center">
          <button class="btn" id="btnHint">💡 Hint</button>
          <button class="btn" id="btnExplain">🪄 Explain</button>
          <button class="btn" id="btnRead">🗣️ Read</button>
          <button class="btn secondary" id="btnQuit">🏠 Home</button>
        </div>
        <div id="hintBox" class="hint hide"></div>
      </div>
    </section>

    <!-- Game -->
    <section id="game" class="card hide">
      <div class="row" style="justify-content:space-between; align-items:center; gap:8px;">
        <div class="pill" id="gameHeaderPill"><span>🐱</span> Bella & Cupcakes</div>
        <div class="pill">Speed: <b id="speedLabel">1x</b></div>
        <button class="btn secondary" id="btnAvatarToggle">Swap to 🐭</button>
      </div>
      <div class="game-wrap">
        <canvas id="gameCanvas" width="420" height="420" aria-label="Cupcake game"></canvas>
        <div class="dpad">
          <button style="grid-area:up" aria-label="Up" id="btnUp">⬆️</button>
          <button style="grid-area:left" aria-label="Left" id="btnLeft">⬅️</button>
          <button style="grid-area:right" aria-label="Right" id="btnRight">➡️</button>
          <button style="grid-area:down" aria-label="Down" id="btnDown">⬇️</button>
        </div>
        <div class="row center">
          <button class="btn" id="btnStartGame">▶️ Start</button>
          <button class="btn secondary" id="btnGameHome">🏠 Home</button>
        </div>
      </div>
    </section>

    <!-- Stickers -->
    <section id="stickers" class="card hide">
      <h2>My Reward Sticker Book</h2>
      <div class="sticker-wrap">
        <div class="sticker-palette" id="stickerPalette" aria-label="Sticker palette"></div>
        <div class="sticker-board" id="stickerBoard" aria-label="Sticker board"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn secondary" id="btnClearStickers">🧽 Clear Board</button>
        <button class="btn" id="btnStickerHome">🏠 Home</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-nav">
      <button class="btn" id="navHome">🏠 Home</button>
      <button class="btn" id="navActivities">🎯 Practice</button>
      <button class="btn" id="navGame">🐱 Game</button>
      <button class="btn" id="navStickers">🏷️ Stickers</button>
      <button class="btn" id="navParent">👪 Parent</button>
    </div>
  </footer>
</div>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- Parent Modal -->
<div class="modal" id="parentModal" role="dialog" aria-modal="true" aria-labelledby="parentTitle">
  <div class="inner">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2 id="parentTitle">Parent View — Riley</h2>
      <button class="btn" id="btnCloseParent">✖️ Close</button>
    </div>
    <div class="row" style="flex-wrap:wrap; gap:12px;">
      <span class="pill">🔥 Streak: <b id="pvStreak">0</b> days</span>
      <span class="pill">⭐ Stars: <b id="pvStars">0</b></span>
      <span class="pill">🏅 Badges: <b id="pvBadges">0</b></span>
      <span class="pill">⏱️ Today: <b id="pvTime">0m</b></span>
      <span class="pill">🎯 Score Today: <b id="pvScore">0</b></span>
    </div>
    <h3>Accuracy by Topic (today)</h3>
    <div class="stats" id="pvStats"></div>
    <h3>What to practice next</h3>
    <div class="note" id="pvNote">Loading…</div>
  </div>
</div>

<!-- Voice Modal -->
<div class="modal" id="voiceModal" role="dialog" aria-modal="true" aria-labelledby="voiceTitle">
  <div class="inner">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2 id="voiceTitle">Voice & Read‑Aloud</h2>
      <button class="btn" id="btnCloseVoice">✖️ Close</button>
    </div>
    <div class="card">
      <div class="row" style="align-items:center; gap:10px;">
        <label for="voiceSelect"><b>Voice</b></label>
        <select id="voiceSelect" style="flex:1; min-width:240px;"></select>
      </div>
      <div class="row" style="margin-top:8px; align-items:center;">
        <label style="min-width:70px">Pitch</label>
        <input type="range" id="voicePitch" min="0.8" max="1.5" step="0.05" value="1.15" />
        <label style="min-width:70px">Rate</label>
        <input type="range" id="voiceRate" min="0.8" max="1.2" step="0.05" value="0.95" />
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px; gap:8px;">
        <button class="btn" id="btnPreviewVoice">▶️ Preview</button>
        <button class="btn" id="btnSaveVoice">💾 Save Voice</button>
      </div>
      <p class="hint" style="margin-top:10px">Tip: Some browsers only load voices after you click once on the page. We default to a friendly female voice when available.</p>
    </div>
  </div>
</div>

<!-- Diagnostics Modal -->
<div class="modal" id="diagModal" role="dialog" aria-modal="true" aria-labelledby="diagTitle">
  <div class="inner">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2 id="diagTitle">Diagnostics & Self‑Tests</h2>
      <button class="btn" id="btnCloseDiag">✖️ Close</button>
    </div>
    <div id="diagResults" class="card" style="margin-top:8px; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
    <div class="row" style="justify-content:flex-end; margin-top:8px">
      <button class="btn" id="btnRunTests">▶️ Run Tests</button>
    </div>
  </div>
</div>

<script>
/* ============================
    Riley's Pink Math Playground (single-file)
    Debug-hardened: early guards for MetaMask/web3 errors + self-tests.
   ============================ */
(function(){
  "use strict";
  // --- Utilities ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
  const rand = (n)=> Math.floor(Math.random()*n);
  const todayStr = ()=>{ const d=new Date(); const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0'); const da=d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${da}`; };
  const Toast = { el:null, show(msg, ms=3000){ if(!this.el) this.el=$('#toast'); if(!this.el) return; this.el.textContent=msg; this.el.classList.add('show'); setTimeout(()=> this.el.classList.remove('show'), ms); } };

  // --- Global error guards (MetaMask/web3) ---
  let __mmErrorHandled = false;
  window.addEventListener('error', (e)=>{
    const m = e && (e.message || (e.error && e.error.message));
    if(/metamask|web3|ethereum/i.test(String(m||''))){
      e.preventDefault(); __mmErrorHandled = true; console.warn('MetaMask/web3 error suppressed:', m);
      Toast.show('Note: Web3/MetaMask not required. Ignored an extension error.');
    }
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const msg = String((e && (e.reason && (e.reason.message||e.reason)))||'');
    if(/metamask|web3|ethereum/i.test(msg)){
      e.preventDefault(); __mmErrorHandled = true; console.warn('MetaMask/web3 rejection suppressed:', msg);
      Toast.show('Note: Web3/MetaMask not required. Ignored an extension error.');
    }
  });

  // --- Storage & Progress ---
  const STORAGE_KEY = 'mathPlaygroundProgressV1';
  const DEFAULT_PROGRESS = {
    lastPlayed: null,
    streakDays: 0,
    stars: 0,
    badges: [],
    difficulty: { arithmetic:1, bonds:1, place:1, tables:1, words:1 },
    days: {},
    stats:{ tableCorrect:0, cupcakes:0 },
    stickers:{ unlocked:["⭐","🧁","🐭","🌈","🐱","🦄","🎈","🍓","🚀","🎤","🎶","💜","🎧","✨"],
              owned:["⭐","🧁","🐱","💜"],
              placements:[] },
    settings:{ muted:false, tts:true, voiceName:null, pitch:1.15, rate:0.95 },
    profile:{ name:"Riley", pet:"Bella", likes:["K-pop"], favorite:"Huntrix", avatar:"cat" }
  };
  let progress = loadProgress();
  bumpDailyStreak();
  const sessionTimer = setInterval(()=> addTime(1), 1000);
  window.addEventListener('beforeunload', ()=> saveProgress());

  function loadProgress(){
    try{
      const s = localStorage.getItem(STORAGE_KEY);
      if(!s) return structuredClone(DEFAULT_PROGRESS);
      const obj = JSON.parse(s);
      return Object.assign(structuredClone(DEFAULT_PROGRESS), obj);
    }catch(e){
      console.warn('Could not load progress', e);
      return structuredClone(DEFAULT_PROGRESS);
    }
  }
  function saveProgress(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }
  function addTime(sec){
    const key=todayStr();
    if(!progress.days[key]) progress.days[key] = { timeSpent:0, topics:{}, score:0 };
    progress.days[key].timeSpent += sec;
    saveProgress();
    updateHeader();
  }
  function bumpDailyStreak(){
    const key=todayStr();
    const last = progress.lastPlayed;
    if(last!==key){
      const lastDate = last? new Date(last): null;
      const now = new Date(key);
      if(!last){ progress.streakDays = 1; }
      else {
        const diffDays = Math.round((now - lastDate)/86400000);
        progress.streakDays = (diffDays===1)? (progress.streakDays+1) : 1;
      }
      progress.lastPlayed = key; saveProgress();
    }
  }

  // --- Sounds (WebAudio) ---
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} }
  function playTone(freq=880, dur=0.12, type='sine', vol=0.2){
    if(progress.settings.muted) return;
    ensureAudio(); if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.value=vol; o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    o.stop(audioCtx.currentTime + dur);
  }
  function sCorrect(){ playTone(880, .1,'triangle',.15); setTimeout(()=>playTone(1320,.12,'triangle',.15),100); }
  function sWrong(){ playTone(180,.15,'sawtooth',.15); }
  function sCheer(){ [660,880,990,1320].forEach((f,i)=> setTimeout(()=>playTone(f,.08,'square',.12),i*80)); }
  function playHuntrixChime(){ if(progress.settings.muted) return; ensureAudio(); const notes=[523,659,784,988,1046,988,784,659]; notes.forEach((f,i)=> setTimeout(()=> playTone(f,0.18,'triangle',0.18), i*140)); speak('Huntrix!'); }

  // --- Speech / Voice Picker ---
  let allVoices = [];
  function refreshVoices(){ try{ allVoices = window.speechSynthesis ? speechSynthesis.getVoices() : []; populateVoiceUI(); }catch(e){ allVoices=[]; } }
  if('speechSynthesis' in window){ speechSynthesis.addEventListener('voiceschanged', refreshVoices); setTimeout(refreshVoices, 0); }

  function guessFemaleVoice(vs){
    if(!vs || !vs.length) return null;
    const femRe = /(female|woman|samantha|victoria|karen|zira|aria|jenny|olivia|emma|nina|joanna|luna|ava|naomi|mia|allison|zoe|tessa|sarah)/i;
    let v = vs.find(v=> femRe.test(v.name)||femRe.test(v.voiceURI));
    if(!v) v = vs.find(v=> /en(-|\s)?(US|GB|UK|AU|CA|IN)/i.test(v.lang) && femRe.test(v.name||''));
    if(!v) v = vs.find(v=> /en/i.test(v.lang));
    return v||vs[0];
  }
  function getPreferredVoice(){
    if(!('speechSynthesis' in window)) return null;
    const vs = allVoices && allVoices.length? allVoices : speechSynthesis.getVoices();
    let v = null;
    if(progress.settings.voiceName){ v = vs.find(x=> x.name===progress.settings.voiceName) || null; }
    if(!v) v = guessFemaleVoice(vs);
    return v;
  }
  function speak(text){
    if(progress.settings.muted || !progress.settings.tts || !('speechSynthesis' in window)) return;
    var u = new SpeechSynthesisUtterance(text);
    var v = getPreferredVoice(); if(v) u.voice = v;
    u.rate = progress.settings.rate || 0.95;
    u.pitch = progress.settings.pitch || 1.15;
    u.volume = 1;
    try { window.speechSynthesis.speak(u); } catch(e) {}
  }
  // Voice UI helpers and events
  function populateVoiceUI(){
    var sel=document.getElementById('voiceSelect'); if(!sel) return;
    var vs = ('speechSynthesis' in window)? (window.speechSynthesis.getVoices()||[]) : [];
    sel.innerHTML = '';
    for(var i=0;i<vs.length;i++){
      var opt=document.createElement('option'); opt.value=vs[i].name; opt.textContent=vs[i].name + ' — ' + vs[i].lang; sel.appendChild(opt);
    }
    var chosen = progress.settings.voiceName || (guessFemaleVoice(vs) ? guessFemaleVoice(vs).name : null);
    if(chosen){ sel.value = chosen; }
    var p=document.getElementById('voicePitch'); var r=document.getElementById('voiceRate');
    if(p) p.value = progress.settings.pitch || 1.15;
    if(r) r.value = progress.settings.rate || 0.95;
  }
  var _btnVoice = document.getElementById('btnVoice');
  if(_btnVoice){ _btnVoice.addEventListener('click', function(){ populateVoiceUI(); document.getElementById('voiceModal').classList.add('show'); }); }
  var _btnCloseVoice = document.getElementById('btnCloseVoice'); if(_btnCloseVoice){ _btnCloseVoice.addEventListener('click', function(){ document.getElementById('voiceModal').classList.remove('show'); }); }
  var _btnPreviewVoice = document.getElementById('btnPreviewVoice'); if(_btnPreviewVoice){ _btnPreviewVoice.addEventListener('click', function(){ speak('Hi Riley! I am ready to help you.'); }); }
  var _btnSaveVoice = document.getElementById('btnSaveVoice'); if(_btnSaveVoice){ _btnSaveVoice.addEventListener('click', function(){
    var sel=document.getElementById('voiceSelect'); var name=sel && sel.value;
    var p=parseFloat(document.getElementById('voicePitch').value)||1.15; var r=parseFloat(document.getElementById('voiceRate').value)||0.95;
    progress.settings.voiceName = name || null; progress.settings.pitch = p; progress.settings.rate = r; saveProgress(); Toast.show('Saved voice settings!');
  }); }

  const confetti = (function(){
    const cvs = $('#confetti'); const ctx = cvs.getContext('2d');
    let parts=[]; let running=false;
    function resize(){ cvs.width=window.innerWidth; cvs.height=window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    function burst(count=120){
      const colors=['#fff','#ffd84d','#ff5aa5','#ff8ec6','#b57bff','#9b5de5'];
      for(let i=0;i<count;i++){
        parts.push({ x:cvs.width/2+(Math.random()-0.5)*120, y:cvs.height/3, vx:(Math.random()-0.5)*6, vy:(Math.random()*-6)-2, g:0.15+Math.random()*0.2, s:3+Math.random()*4, r:Math.random()*Math.PI, vr:(Math.random()-0.5)*0.2, c:colors[rand(colors.length)] });
      }
      if(!running){ running=true; requestAnimationFrame(loop); }
    }
    function loop(){
      const ctx2=ctx; ctx2.clearRect(0,0,cvs.width,cvs.height);
      parts.forEach(p=>{ p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += p.vr; ctx2.save(); ctx2.translate(p.x,p.y); ctx2.rotate(p.r); ctx2.fillStyle=p.c; ctx2.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx2.restore(); });
      parts = parts.filter(p=> p.y < cvs.height+20);
      if(parts.length>0) requestAnimationFrame(loop); else running=false;
    }
    return { burst };
  })();

  // --- UI Nav ---
  const pages = { home: $('#home'), activity: $('#activity'), game: $('#game'), stickers: $('#stickers') };
  function show(id){ Object.values(pages).forEach(p=> p.classList.add('hide')); pages[id].classList.remove('hide'); }

  // --- Header controls ---
  function updateHeader(){
    $('#streakDays').textContent = progress.streakDays;
    $('#starCount').textContent = progress.stars;
    $('#badgeCount').textContent = progress.badges.length;
    $('#btnToggleSound').textContent = progress.settings.muted? '🔇 Sounds Off' : '🔊 Sounds On';
    $('#btnToggleTTS').textContent = progress.settings.tts? '🗣️ Read Aloud On' : '🤫 Read Aloud Off';
    const fav = $('#favPill'); if(fav) fav.querySelector('#favGroup').textContent = progress.profile.favorite || 'K-pop';
  }
  updateHeader();

  $('#btnToggleSound').addEventListener('click', ()=>{ progress.settings.muted=!progress.settings.muted; saveProgress(); updateHeader(); });
  $('#btnToggleTTS').addEventListener('click', ()=>{ progress.settings.tts=!progress.settings.tts; saveProgress(); updateHeader(); });
  $('#btnChime').addEventListener('click', playHuntrixChime);
  $('#btnReset').addEventListener('click', ()=>{ if(confirm('Reset all progress, stars, stickers, and badges?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
  $('#btnDiag').addEventListener('click', ()=>{ $('#diagModal').classList.add('show'); });
  $('#btnCloseDiag').addEventListener('click', ()=>{ $('#diagModal').classList.remove('show'); });
  function buildHTML(){ return '<!DOCTYPE html>' + document.documentElement.outerHTML; }
  function popOut(){
    const html = buildHTML();
    try{
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 4000);
    }catch(e){
      try{ const w = window.open('data:text/html;charset=utf-8,'+encodeURIComponent(html),'_blank','noopener'); if(!w){ throw new Error('Popup blocked'); } }
      catch(err){ Toast.show('Pop-up blocked. Use Download HTML instead.'); }
    }
  }
  function downloadHTML(){
    const blob = new Blob([buildHTML()], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='riley-math.html'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
  }
  function exportProgress(){
    const name = 'riley-progress-' + new Date().toISOString().replace(/[:.]/g,'-') + '.json';
    const blob = new Blob([JSON.stringify(progress,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500);
    Toast.show('Progress exported. Keep this file safe to import on another device.');
  }
  function importProgress(file){
    const r = new FileReader(); r.onload = function(){
      try{ const obj = JSON.parse(String(r.result||'{}')); if(!obj || typeof obj!=='object' || !obj.days){ throw new Error('Invalid file'); }
        progress = Object.assign(structuredClone(DEFAULT_PROGRESS), obj); saveProgress(); updateHeader(); renderStickerUI(); Toast.show('Progress imported!'); }
      catch(e){ Toast.show('Import failed: not a valid progress file.'); }
    }; r.readAsText(file);
  }
  (function(el){ if(el) el.addEventListener('click', popOut); })(document.getElementById('btnPopout'));
  (function(el){ if(el) el.addEventListener('click', downloadHTML); })(document.getElementById('btnDownload'));
  (function(el){ if(el) el.addEventListener('click', exportProgress); })(document.getElementById('btnExport'));
  (function(el){ if(el) el.addEventListener('click', function(){ var f=document.getElementById('fileImport'); if(f) f.click(); }); })(document.getElementById('btnImport'));
  (function(el){ if(el) el.addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(f) importProgress(f); e.target.value=''; }); })(document.getElementById('fileImport'));

  // --- Fullscreen Toggle ---
  function isFullscreen(){ return !!(document.fullscreenElement || document.webkitFullscreenElement); }
  function isFullscreenSupported(){
    const el = document.documentElement;
    return !!(document.fullscreenEnabled || document.webkitFullscreenEnabled || el.requestFullscreen || el.webkitRequestFullscreen);
  }
  function updateFSButton(){
    const btn = $('#btnFullscreen'); if(!btn) return;
    if(isFullscreen()) btn.textContent = '🗗 Exit Full Screen';
    else if(document.body.classList.contains('fill-active')) btn.textContent = '🗗 Exit Fill Screen';
    else btn.textContent = '⛶ Full Screen';
  }
  async function enterFS(){
    try{
      const el = document.documentElement;
      if(!isFullscreenSupported()) throw new Error('Fullscreen not supported');
      if(el.requestFullscreen) return await el.requestFullscreen();
      if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      throw new Error('Fullscreen not supported');
    }catch(e){
      Toast.show('Full screen not available here. Using Fill Screen instead.');
      throw e;
    }
  }
  async function exitFS(){
    try{
      if(document.exitFullscreen) return await document.exitFullscreen();
      if(document.webkitExitFullscreen) return document.webkitExitFullscreen();
    }catch(e){ /* ignore */ }
  }
  function enterFill(){ document.body.classList.add('fill-active'); updateFSButton(); resizeGame(); }
  function exitFill(){ document.body.classList.remove('fill-active'); updateFSButton(); resizeGame(); }
  async function toggleFullscreen(){
    if(isFullscreen()) { await exitFS(); exitFill(); return; }
    try{ await enterFS(); setTimeout(()=>{ if(!isFullscreen()) enterFill(); }, 300); }
    catch(e){ enterFill(); }
  }
  document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', updateFSButton);
  document.addEventListener('webkitfullscreenchange', updateFSButton);
  window.addEventListener('resize', ()=>{ updateFSButton(); if(document.body.classList.contains('fill-active')) resizeGame(); });
  updateFSButton();

  // Footer nav
  $('#navHome').onclick = ()=> show('home');
  $('#navActivities').onclick = ()=> show('home');
  $('#navGame').onclick = ()=>{ show('game'); resizeGame(); };
  $('#navStickers').onclick = ()=>{ show('stickers'); renderStickerUI(); };
  $('#navParent').onclick = ()=> openParent();

  // Home tiles
  $$('#home .tile[data-activity]').forEach(el=> el.addEventListener('click', ()=> startActivity(el.dataset.activity)) );
  $('#tileGame').addEventListener('click', ()=>{ show('game'); resizeGame(); });
  $('#tileStickers').addEventListener('click', ()=>{ show('stickers'); renderStickerUI(); });

  // Parent view
  $('#btnParent').onclick = ()=> openParent();
  $('#btnCloseParent').onclick = ()=> closeParent();
  function openParent(){ fillParent(); $('#parentModal').classList.add('show'); }
  function closeParent(){ $('#parentModal').classList.remove('show'); }
  function fillParent(){
    $('#pvStreak').textContent = progress.streakDays;
    $('#pvStars').textContent = progress.stars;
    $('#pvBadges').textContent = progress.badges.length;
    const key=todayStr(); const day=progress.days[key]||{timeSpent:0,topics:{},score:0};
    $('#pvTime').textContent = Math.floor(day.timeSpent/60)+ 'm';
    $('#pvScore').textContent = day.score||0;
    const topics=['arithmetic','bonds','place','tables','words'];
    const wrap=$('#pvStats'); wrap.innerHTML='';
    let worst={topic:null,acc:1, attempts:0};
    topics.forEach(tp=>{
      const t=day.topics[tp]||{correct:0,attempts:0};
      const acc = t.attempts? (t.correct/t.attempts): 0;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<div class="row" style="justify-content:space-between"><b>${nameOf(tp)}</b><span>${Math.round(acc*100)}% (${t.correct}/${t.attempts})</span></div>
      <div class="bar" aria-hidden="true"><div style="width:${Math.round(acc*100)}%"></div></div>`;
      wrap.appendChild(card);
      if( (t.attempts>=5 && acc < worst.acc) || (!worst.topic && t.attempts<5) ){
        worst={topic:tp,acc,attempts:t.attempts};
      }
    });
    $('#pvNote').textContent = worst.attempts<5 ? `Try a few more in ${nameOf(worst.topic||'arithmetic')} to build confidence.` : `Focus on ${nameOf(worst.topic)} next — we can get that accuracy up!`;
  }

  function nameOf(tp){
    return { arithmetic:'Quick-Fire Arithmetic', bonds:'Number Bonds', place:'Place Value', tables:'Times Tables', words:'Word Problems' }[tp]||tp;
  }

  // --- Activity Engine ---
  const activityIcons = { arithmetic:'➕', bonds:'🧩', place:'🏗️', tables:'📙', words:'📖' };
  const sessionSize = 10;
  let current = { topic:null, qIndex:0, correct:0, attempts:0, question:null, allowAnswer:true };

  $('#btnHint').onclick = ()=> showHint();
  $('#btnExplain').onclick = ()=> showExplain();
  $('#btnRead').onclick = ()=> speak($('#questionText').textContent);
  $('#btnQuit').onclick = ()=>{ show('home'); };

  function startActivity(topic){
    current = { topic, qIndex:0, correct:0, attempts:0, question:null, allowAnswer:true };
    $('#activityIcon').textContent = activityIcons[topic]||'🎯';
    $('#activityTitle').textContent = nameOf(topic);
    $('#hintBox').classList.add('hide'); $('#hintBox').textContent='';
    show('activity');
    nextQuestion();
  }

  function nextQuestion(){
    current.qIndex++;
    $('#qNum').textContent = current.qIndex;
    $('#sessionProgress').style.width = ((current.qIndex-1)/sessionSize*100)+'%';
    $('#hintBox').classList.add('hide'); $('#hintBox').textContent='';
    const diff = clamp(progress.difficulty[current.topic]||1,1,5);
    const q = generateQuestion(current.topic, diff);
    current.question = q; renderQuestion(q);
    if(progress.settings.tts) setTimeout(()=> speak(q.say||q.text||'Ready?'), 150);
  }

  function endSession(){
    $('#sessionProgress').style.width = '100%';
    const scoreAdd = current.correct*10;
    addScore('general', scoreAdd);
    progress.stars += current.correct; // 1 star per correct
    if(current.correct===sessionSize){ progress.stars += 5; awardBadge('Perfect Session'); sCheer(); }
    saveProgress(); updateHeader();
    confetti.burst(180);
    alert(`Nice work! You got ${current.correct}/${sessionSize}. You earned ${current.correct}⭐${current.correct===sessionSize? ' + 5 bonus!':''}`);
    show('home');
  }

  function addScore(topic, pts){
    const key=todayStr(); if(!progress.days[key]) progress.days[key]={timeSpent:0,topics:{},score:0};
    progress.days[key].score += pts;
    saveTopic(topic, { deltaCorrect:0, deltaAttempts:0 });
  }

  function saveTopic(topic, {deltaCorrect=0, deltaAttempts=0}){
    const key=todayStr(); if(!progress.days[key]) progress.days[key]={timeSpent:0,topics:{},score:0};
    const t = progress.days[key].topics[topic] || {correct:0, attempts:0};
    t.correct += deltaCorrect; t.attempts += deltaAttempts; progress.days[key].topics[topic]=t; saveProgress();
  }

  function renderQuestion(q){
    $('#visuals').innerHTML = q.visual||'';
    $('#questionText').textContent = q.text;
    const ui=$('#answerUI'); ui.innerHTML='';
    if(q.choices){
      const wrap=document.createElement('div'); wrap.className='choices';
      q.choices.forEach(choice=>{
        const b=document.createElement('button'); b.className='choice'; b.textContent=choice; b.onclick = ()=> submitAnswer(choice);
        wrap.appendChild(b);
      }); ui.appendChild(wrap);
    } else {
      const inp=document.createElement('input'); inp.type='number'; inp.className='answer-input'; inp.inputMode='numeric'; inp.setAttribute('aria-label','Your answer');
      const go=document.createElement('button'); go.className='btn'; go.textContent='✅ Check'; go.onclick = ()=> submitAnswer(inp.value.trim());
      const row=document.createElement('div'); row.className='row'; row.style.justifyContent='center'; row.appendChild(inp); row.appendChild(go); ui.appendChild(row);
      setTimeout(()=> inp.focus(), 100);
    }
  }

  function submitAnswer(val){
    if(!current.allowAnswer) return; current.allowAnswer=false;
    const q=current.question; const correct = (String(val)===String(q.answer));
    saveTopic(current.topic, { deltaAttempts:1, deltaCorrect: correct?1:0 });
    current.attempts++; if(correct) current.correct++;
    handleDifficulty(current.topic, correct);
    if(correct){ sCorrect(); confetti.burst(40); speak(randPraise()); }
    else { sWrong(); }

    if(q.explain){ $('#hintBox').classList.remove('hide'); $('#hintBox').innerHTML = (correct? 'Great! ':'Almost! ') + q.explain; }
    if(current.qIndex>=sessionSize){ setTimeout(endSession, 400); }
    else { setTimeout(()=>{ current.allowAnswer=true; nextQuestion(); }, correct? 350 : 500); }
    updateHeader(); saveProgress();
  }

  function showHint(){ const q=current.question; if(!q) return; const box=$('#hintBox'); box.classList.remove('hide'); box.innerHTML = q.hint || 'Try your best! Count in steps, use your fingers, or break into tens.'; }
  function showExplain(){ const q=current.question; if(!q) return; const box=$('#hintBox'); box.classList.remove('hide'); box.innerHTML = q.explain || 'Think about the steps: read the question, spot the operation, solve carefully.'; }
  function randPraise(){ const arr=['Great job, Riley!','Nice work!','You rock, Riley!','Fantastic!','Brilliant!','High five!','Mic drop!','Encore!','Dance break!','Bella is proud!']; return arr[rand(arr.length)]; }

  function handleDifficulty(topic, correct){
    const d = progress.difficulty[topic]||1; const key=`diff_${topic}`; progress[key] = progress[key]||{ streak:0, miss:0 };
    if(correct){ progress[key].streak++; progress[key].miss=0; }
    else { progress[key].miss++; progress[key].streak=0; }
    if(progress[key].streak>=3){ progress.difficulty[topic]=clamp(d+1,1,5); progress[key].streak=0; awardBadge('Level Up'); }
    if(progress[key].miss>=2){ progress.difficulty[topic]=clamp(d-1,1,5); progress[key].miss=0; }
    saveProgress();
  }

  function awardBadge(name){ if(progress.badges.includes(name)) return; progress.badges.push(name); saveProgress(); updateHeader(); }

  // --- Question Generators ---
  function generateQuestion(topic, diff){
    switch(topic){
      case 'arithmetic': return qArithmetic(diff);
      case 'bonds': return qBonds(diff);
      case 'place': return qPlace(diff);
      case 'tables': return qTables(diff);
      case 'words': return qWord(diff);
      default: return qArithmetic(1);
    }
  }

  function qArithmetic(diff){
    const ops = diff<=2? ['+','-'] : diff===3? ['+','-','×'] : ['+','-','×','÷'];
    const op = ops[rand(ops.length)];
    let a,b,ans,text,explain,hint;
    const limit = diff<=2? 20 : diff===3? 50 : 100;
    if(op==='+'){ a=rand(limit+1); b=rand(limit+1-a); ans=a+b; text=`What is ${a} + ${b}?`; hint=`Add the ones first: ${a%10} + ${b%10}.`; explain=`${a} + ${b} = ${ans}.`; }
    if(op==='-'){ a=rand(limit+1); b=rand(a+1); ans=a-b; text=`What is ${a} − ${b}?`; hint=`Count back ${b} from ${a}.`; explain=`${a} - ${b} = ${ans}.`; }
    if(op==='×'){ do { a=clamp(rand(12),1,12); b=clamp(rand(12),1,12); ans=a*b; } while(ans>100); text=`What is ${a} × ${b}?`; hint=`Count in ${a} groups, ${b} times.`; explain=`${a} × ${b} means ${b} groups of ${a}.`; }
    if(op==='÷'){ do { b=clamp(rand(12),1,12); ans=clamp(rand(12),1,12); a=b*ans; } while(a>100); text=`What is ${a} ÷ ${b}?`; hint=`How many ${b}s fit into ${a}?`; explain=`${a} ÷ ${b} = ${ans} because ${b} × ${ans} = ${a}.`; }
    const choices = makeChoices(ans);
    return { text, answer: ans, choices, hint, explain, say:text };
  }

  function qBonds(diff){
    const target = diff<=2? (diff===1?10:20) : diff===3? 50 : 100;
    const a = rand(target); const ans = target - a;
    const text = `Number bonds to ${target}: What goes with ${a} to make ${target}?`;
    const hint = `Think: ${a} + ? = ${target}. Count up from ${a} to ${target}.`;
    const explain = `${a} + ${ans} = ${target}.`;
    return { text, answer: ans, choices: makeChoices(ans), hint, explain };
  }

  function qPlace(diff){
    const digits = diff<=2? (diff===1? 2:3) : 4;
    const n = Math.floor(Math.random() * Math.pow(10,digits-1)*9) + Math.pow(10,digits-1);
    const ask = ['ones','tens','hundreds','thousands'][rand(Math.min(4,digits))];
    const placeVal = (p=>{ if(p==='ones') return n%10; if(p==='tens') return Math.floor(n/10)%10; if(p==='hundreds') return Math.floor(n/100)%10; if(p==='thousands') return Math.floor(n/1000)%10; }) (ask);
    const value = placeVal * (ask==='ones'?1: ask==='tens'?10: ask==='hundreds'?100:1000);
    const text = diff<5 ? `In ${n}, what digit is in the ${ask} place?` : `In ${n}, what is the value of the ${ask} digit?`;
    const ans = diff<5? placeVal : value;
    const hint = `Write ${n} in expanded form.`;
    const explain = `${n} = ${Math.floor(n/1000)%10*1000} + ${Math.floor(n/100)%10*100} + ${Math.floor(n/10)%10*10} + ${n%10}.`;
    return { text, answer: ans, choices: makeChoices(ans), hint, explain };
  }

  function qTables(diff){
    let a,b,ans; do{ a = clamp(rand(12),1,12); b = diff<=2? clamp(rand(6),1,6) : clamp(rand(12),1,12); ans = a*b; } while(ans>100);
    const text = `Times tables: ${a} × ${b} = ?`;
    const hint = `Skip-count: ${Array(b).fill(a).map((v,i)=> (i+1)*a).join(', ')}`;
